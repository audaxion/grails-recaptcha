<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Grails ReCaptcha by iamthechad</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Grails ReCaptcha</h1>
          <h2>ReCaptcha plugin for Grails</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/iamthechad/grails-recaptcha/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/iamthechad/grails-recaptcha/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/iamthechad/grails-recaptcha" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>Introduction</h1>

<p>This plugin is designed to make using the ReCaptcha and Mailhide services within Grails easy. In order to use this plugin, you must have a ReCaptcha account, available from <a href="http://www.google.com/recaptcha">http://www.google.com/recaptcha</a>.</p>

<h1>Installation</h1>

<p>Add the following to your <code>grails-app/conf/BuildConfig.groovy</code></p>

<pre><code>…
plugins {
    …
    compile ':recaptcha:0.6.2'
    …
}
</code></pre>

<p>Upon installation, run <code>grails recaptcha-quickstart</code> to create the skeleton configuration. The quickstart has two targets: <code>integrated</code> or <code>standalone</code>, depending on where you'd like the configuration to live.</p>

<h2>Integrated Configuration</h2>

<p>Integrated configuration adds the following to the end of your <code>Config.groovy</code> file:</p>

<pre><code>// Added by the Recaptcha plugin:
recaptcha {
    // These keys are generated by the ReCaptcha service
    publicKey = ""
    privateKey = ""

    // Include the noscript tags in the generated captcha
    includeNoScript = true

    // Force language change. See this for more: http://code.google.com/p/recaptcha/issues/detail?id=133
    forceLanguageInURL = false

    // Set to false to disable the display of captcha
    enabled = true

    // Communicate using HTTPS
    useSecureAPI = true
}

mailhide {
    // Generated by the Mailhide service
    publicKey = ""
    privateKey = ""
}
</code></pre>

<p>This configuration can be modified to mimic the standalone if there is a need for different behavior depending on the current environment.</p>

<h2>Standalone Configuration</h2>

<p>Standlaone configuration creates a file called  <code>RecaptchaConfig.groovy</code>  in  <code>grails-app/conf</code> with the following content:</p>

<pre><code>recaptcha {
    // These keys are generated by the ReCaptcha service
    publicKey = ""
    privateKey = ""

    // Include the noscript tags in the generated captcha
    includeNoScript = true

    // Force language change. See this for more: http://code.google.com/p/recaptcha/issues/detail?id=133
    forceLanguageInURL = false
}

mailhide {
    publicKey = ""
    privateKey = ""
} 

environments {
  development {
    recaptcha {
      // Set to false to disable the display of captcha
      enabled = false

      // Communicate using HTTPS
      useSecureAPI = false
    }
  }
  production {
    recaptcha {
      // Set to false to disable the display of captcha
      enabled = true

      // Communicate using HTTPS
      useSecureAPI = true
    }
  }
}
</code></pre>

<h1>Usage - ReCaptcha</h1>

<p>The plugin is simple to use. In order to use it, there are four basic steps:</p>

<h2>Edit the Configuration</h2>

<p>The configuration values are pretty self-explanatory, and match with values used by the ReCaptcha service. You must enter your public and private ReCaptcha keys, or errors will be thrown when trying to display a captcha.</p>

<h2>Use the Tag Library</h2>

<p>The plugin includes four ReCaptcha tags:  <code>&lt;recaptcha:ifEnabled&gt;</code>, <code>&lt;recaptcha:ifDisabled&gt;</code>, <code>&lt;recaptcha:recaptcha&gt;</code>, and  <code>&lt;recaptcha:ifFailed&gt;</code>.</p>

<ul>
<li>The <code>&lt;recaptcha:ifEnabled&gt;</code> tag is a simple utility tag that will render the contents of the tag if the captcha is enabled in  <code>RecaptchaConfig.groovy</code>.</li>
<li>The <code>&lt;recaptcha:ifDisabled&gt;</code> tag is a simple utility tag that will render the contents of the tag if the captcha is disabled in  <code>RecaptchaConfig.groovy</code>.</li>
<li>The <code>&lt;recaptcha:recaptcha&gt;</code> tag is responsible for generating the correct HTML output to display the captcha. It supports four attributes: "theme", "lang", "tabindex", and "custom_theme_widget". These attributes map directly to the values that can be set according to the ReCaptcha API. See the <a href="https://developers.google.com/recaptcha/intro">ReCaptcha Client Guide</a> for more details.</li>
<li>The <code>&lt;recaptcha:recaptchaAjax&gt;</code> tag is responsible for creating the correct HTML output to display the captcha in an AJAX manner. The tag creates a JavaScript method called <code>showRecaptcha</code> that takes an element name as a parameter. This element will contain the generated ReCaptcha widget. This tag supports the same attributes as the <code>&lt;recaptcha:recaptcha&gt;</code> tag.</li>
<li>The <code>&lt;recaptcha:ifFailed&gt;</code> tag will render its contents if the previous validation failed. Some ReCaptcha themes, like "clean", do not display error messages and require the developer to show an error message. Use this tag if you're using one of these themes.</li>
</ul><h2>Verify the Captcha</h2>

<p>In your controller, call <code>recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)</code> to verify the answer provided by the user. This method will return true or false, but will set the <code>error_message</code> property on the captcha behind the scenes so that the error message will be properly displayed when the ReCaptcha is redisplayed. Also note that <code>verifyAnswer</code> will return <code>true</code> if the plugin has been disabled in the configuration - this means you won't have to change your controller.</p>

<h2>Clean up After Yourself</h2>

<p>Once the captcha has been verified, call <code>recaptchaService.cleanUp(session)</code>. This is not strictly needed, but it will clean the errors from the session.</p>

<h2>Examples</h2>

<p>Here's a simple example pulled from an account creation application.</p>

<h3>Tag Usage</h3>

<p>In <code>create.gsp</code>, we add the code to show the captcha:</p>

<pre><code>&lt;recaptcha:ifEnabled&gt;
    &lt;recaptcha:recaptcha theme="blackglass"/&gt;
&lt;/recaptcha:ifEnabled&gt;
</code></pre>

<p>In this example, we're using ReCaptcha's "blackglass" theme. Leaving out the "theme" attribute will default the captcha to the "red" theme.</p>

<p>If you are using a theme that does not supply error messages, your code might look like this:</p>

<pre><code>&lt;recaptcha:ifEnabled&gt;
    &lt;recaptcha:recaptcha theme="clean"/&gt;
    &lt;recaptcha:ifFailed&gt;CAPTCHA Failed&lt;/recaptcha:ifFailed&gt;
&lt;/recaptcha:ifEnabled&gt;
</code></pre>

<h3>AJAX Tag Usage</h3>

<pre><code>&lt;g:form action="someAction"&gt;
  &lt;recaptcha:ifEnabled&gt;
      &lt;recaptcha:recaptchaAjax theme="blackglass"/&gt;
  &lt;/recaptcha:ifEnabled&gt;
  &lt;g:submitButton name="show" onclick="showRecaptcha(mydiv); return false;"/&gt;
  &lt;g:submitButton value="Submit" name="submit"/&gt;&lt;br/&gt;
  &lt;div id="mydiv"&gt;&lt;/div&gt;
  &lt;recaptcha:ifFailed&gt;CAPTCHA Failed&lt;/recaptcha:ifFailed&gt;
&lt;/g:form&gt;
</code></pre>

<p>When the <code>show</code> button is clicked, the ReCaptcha widget will be created and displayed in the <code>mydiv</code> element. <strong>The div used to display the widget must be enclosed in the <code>&lt;g:form&gt;</code> or the parameters will not be captured correctly.</strong></p>

<p>It is recommended to use the <code>&lt;recaptcha:ifFailed&gt;</code> tag in conjunction with the AJAX tag.</p>

<h3>Customizing the Language</h3>

<p>If you want to change the language your captcha uses, there are two routes you can follow.</p>

<ul>
<li>Set <code>lang = "someLang"</code> in the <code>&lt;recaptcha/&gt;</code> tag. This has the drawback of only showing the desired language if the user has their browser set to display that language.</li>
<li>Set <code>forceLanguageInURL = true</code> in <code>ReCaptchaConfig.groovy</code>. This will add another parameter to the generated URL, forcing the captcha to be shown in the desired language.</li>
</ul><p>See <a href="http://code.google.com/p/recaptcha/issues/detail?id=133">this discussion</a> for more information about changing the language.
See <a href="https://developers.google.com/recaptcha/docs/customization">ReCaptcha Customization Guide</a> for available languages.</p>

<h3>Verify User Input</h3>

<p>Here's an abbreviated controller class that verifies the captcha value when a new user is saved:</p>

<pre><code>import com.megatome.grails.RecaptchaService
class UserController {
    RecaptchaService recaptchaService

    def save = {
        def user = new User(params)
        ...other validation...
        def recaptchaOK = true
        if (!recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)) {
            recaptchaOK = false
        }
        if(!user.hasErrors() &amp;&amp; recaptchaOK &amp;&amp; user.save()) {
            recaptchaService.cleanUp(session)
            ...other account creation acivities...
            render(view:'showConfirmation',model:[user:user])
        }
        else {
            render(view:'create',model:[user:user])
        }
    }
}
</code></pre>

<h3>Sample Using a Custom Theme</h3>

<pre><code>&lt;g:form action="validateCustom" method="post" &gt;
    &lt;div id="recaptcha_widget" style="display:none"&gt;
        &lt;div id="recaptcha_image" style="width:300px;height:57px;"&gt;&lt;/div&gt;
        &lt;div class="recaptcha_only_if_incorrect_sol" style="color:red;"&gt;
            Incorrect Answer
        &lt;/div&gt;
        Enter the words above:
        &lt;input id="recaptcha_response_field" name="recaptcha_response_field" type="text" autocomplete="off"/&gt;
        &lt;div&gt;
            &lt;a href="javascript:Recaptcha.reload()"&gt;Get another CAPTCHA&lt;/a&gt;
        &lt;/div&gt;
        &lt;div class="recaptcha_only_if_image"&gt;
            &lt;a href="javascript:Recaptcha.switch_type('audio')"&gt;Get an audio CAPTCHA&lt;/a&gt;
        &lt;/div&gt;
        &lt;div&gt;
            &lt;a href="javascript:Recaptcha.showhelp()"&gt;Help&lt;/a&gt;
        &lt;/div&gt;
   &lt;/div&gt;
   &lt;recaptcha:ifEnabled&gt;
       &lt;recaptcha:recaptcha theme="custom" lang="en" custom_theme_widget="recaptcha_widget"/&gt;
   &lt;/recaptcha:ifEnabled&gt;
   &lt;br/&gt;
   &lt;g:submitButton name="submit"/&gt;
&lt;/g:form&gt;
</code></pre>

<h3>Testing</h3>

<p>Starting with version 0.4.5, the plugin should be easier to integrate into test scenarios. You can look at the test cases in the plugin itself, or you can implement something similar to:</p>

<pre><code>private void buildAndCheckAnswer(def postText, def expectedValid, def expectedErrorMessage) {
    def mocker = new MockFor(Post.class)
    mocker.demand.getQueryString(4..4) { new QueryString() }
    mocker.demand.getText { postText }
    mocker.use {
      def response = recaptchaService.checkAnswer("123.123.123.123", "abcdefghijklmnop", "response")

      assertTrue response.valid == expectedValid
      assertEquals expectedErrorMessage, response.errorMessage
    }
}
</code></pre>

<p>The <code>postText</code> parameter represents the response from the ReCaptcha server. Here are examples of simulating success and failure results:</p>

<pre><code>public void testCheckAnswerSuccess() {
    // ReCaptcha server will return true to indicate success
    buildAndCheckAnswer("true", true, null)
}

public void testCheckAnswerFailure() {
    // ReCaptcha server will return false, followed by the error message on a new line for failure
    buildAndCheckAnswer("false\\nError Message", false, "Error Message")
}
</code></pre>

<h1>Usage - Mailhide</h1>

<h2>Edit the Configuration</h2>

<p>The <code>recaptcha-quickstart</code> plugin creates basic configuration. You must enter your public and private Mailhide keys, or errors will be thrown when trying to display a Mailhide link.</p>

<h2>Use the Tag Library</h2>

<p>The plugin includes two Mailhide tags: <code>&lt;recaptcha:mailhide&gt;</code> and <code>&lt;recaptcha:mailhideURL&gt;</code>.</p>

<ul>
<li>The <code>&lt;recaptcha:mailhide&gt;</code> tag creates a Mailhide URL that opens in a new, pop-up window per the Mailhide specification. It supports one attribute: "emailAddress", to specify the email to be hidden. The link will be created around whatever content is in the body of the tag.</li>
<li>The <code>&lt;recaptcha:mailhideURL&gt;</code> tag creates a "raw" URL that can be used however desired. This is useful if the pop-up behavior of the other tag is not wanted. It supports two attributes: "emailAddress" and "var". The "emailAddress" attribute specifies the email to be hidden, while the "var" attribute specifies the name of the variable that the created URL should be available under in the page. The URL variable is only available in the context of the tag body.</li>
</ul><h2>Examples</h2>

<h3>mailhide tag</h3>

<pre><code>&lt;recaptcha:mailhide emailAddress="x@example.com"&gt;Some text to wrap in a link&lt;/recaptcha:mailhide&gt;
</code></pre>

<p>will create:</p>

<pre><code>&lt;a href="http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&amp;c=..encryptedEmail..."
     onclick="window.open('http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&amp;c=...encryptedEmail...', '', 
     'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300'); return false;" 
     title="Reveal this e-mail address"&gt;Some text to wrap in a link&lt;/a&gt;
</code></pre>

<h3>mailhideURL tag</h3>

<pre><code>&lt;recaptcha:mailhideURL emailAddress="x@example.com" var="mu"&gt;
    Created Mailhide URL: ${mu}
&lt;/recaptcha:mailhideURL&gt;
</code></pre>

<p>will create:</p>

<pre><code>Created Mailhide URL: http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&amp;c=...encryptedEmail...
</code></pre>

<h1>Misc.</h1>

<h3>CHANGELOG</h3>

<ul>
<li>0.6.2 Remove spurious <code>println</code> left over. Change install behavior to not create <code>RecaptchaConfig.groovy</code> in <code>_Install.groovy</code>. Add new script <code>recaptcha-quickstart</code> to handle creation of required configuration. </li>
<li>0.6.0 Add the ability to display the widget using AJAX. Change plugin to require Grails 2.0 at a minimum.</li>
<li>0.5.3 Add the ability to force a different language to be displayed.</li>
<li>0.5.1 &amp; 0.5.2 Update to use the new ReCaptcha URLs.</li>
<li>0.5.0 Add Mailhide support. Add support for specifying configuration options elsewhere than <code>RecaptchaConfig.groovy</code> via the <code>grails.config.locations</code> method.</li>
<li>0.4.5 Add code to perform the ReCaptcha functionality - removed recaptcha4j library. Don't add captcha instance to session to avoid serialization issues. Hopefully make it easier to test against.</li>
<li>0.4 New version number for Grails 1.1. Same functionality as 0.3.2</li>
<li>0.3.2 Moved code into packages. Tried to make licensing easier to discern. Updated to Grails 1.0.4</li>
<li>0.3 Added support for environments and new <code>&lt;recaptcha:ifFailed&gt;</code> tag. Updated to Grails 1.0.3</li>
<li>0.2 initial release, developed and tested against Grails 1.0.2</li>
</ul><h3>KNOWN ISSUES</h3>

<ul>
<li>If you are testing locally on a Mac, you may need to change <code>recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)</code> to <code>recaptchaService.verifyAnswer(session, "127.0.0.1", params)</code>. This seems to be an issue with the ReCaptcha service not being able to handle the IPV6 localhost identifier.</li>
</ul><h3>TODO</h3>

<ul>
<li>Automate session cleanup</li>
</ul><h3>Thanks</h3>

<ul>
<li>The <code>recaptcha-quickstart</code> script was borrowed heavily from the <a href="http://grails.org/plugin/spring-security-core">Spring Security Core plugin</a>.</li>
</ul><h1>Suggestions or Comments</h1>

<p>Feel free to submit questions or comments to the Grails users mailing list.</p>

<p><a href="http://grails.org/Mailing+lists">http://grails.org/Mailing+lists</a></p>

<p>Alternatively you can contact me directly - cjohnston at megatome dot com</p>
        </section>

        <footer>
          Grails ReCaptcha is maintained by <a href="https://github.com/iamthechad">iamthechad</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>